<script src="{{ url_for('static', filename='js/app.js') }}"></script>

<!-- POST ARTICLE -->
<article class="post border-b border-gray-200 p-4 mb-4 bg-white shadow-sm" id="post_{{ tweet.post_pk }}"
    data-user-pk="{{ tweet.post_user_fk }}" mix-fade-in="5000">

    {% set avatar = tweet.user_avatar_path %}
    <img src="{% if avatar %}
                {% if avatar.startswith('uploads/') %}
                    {{ url_for('static', filename=avatar) }}
                {% else %}
                    {{ url_for('static', filename='images/' + avatar) }}
                {% endif %}
             {% else %}
                {{ url_for('static', filename='images/avatar.jpg') }}
             {% endif %}" alt="Profile" class="w-8 h-8 rounded-full">

    <div class="post-content">
        <div class="post-header flex items-center space-x-2 text-sm text-gray-500 mb-1">
            <span class="name">{{ tweet.user_first_name }} {{ tweet.user_last_name }}</span>
            <span class="handle">@{{ tweet.user_username }}</span> Â·
            <span class="time">{{ tweet.post_time or '1d' }}</span>
        </div>

        {% if tweet.post_message %}
        <p class="text-gray-800 mb-2">{{ tweet.post_message }}</p>
        {% endif %}

        {% if tweet.post_image_path %}
        {% set filename = tweet.post_image_path %}
        {% set is_video = filename.endswith(('.mp4', '.webm')) %}
        {% if is_video %}
        <video controls class="w-80 mt-2">
            <source
                src="{{ filename.startswith('http') and filename or url_for('static', filename='uploads/' + filename) }}"
                type="video/mp4">
            Your browser does not support the video tag.
        </video>
        {% else %}
        <img src="{{ filename.startswith('http') and filename or url_for('static', filename='uploads/' + filename) }}"
            alt="Post media" class="w-80 mt-2">
        {% endif %}
        {% endif %}

        <!-- POST ACTIONS -->
        <div class="post-actions items-center space-x-4 text-gray-500 text-sm mb-2">
            <span class="action comment-toggle items-center space-x-1 hover:text-blue-500"
                data-post="{{ tweet.post_pk }}">
                <i class="fa-regular fa-comment"></i> {{ tweet.comment_count or 0 }}
            </span>
            <span class="action space-x-1 hover:text-green-500"><i class="fa-solid fa-retweet"></i> 5</span>

            <!-- INCLUDE SINGLE LIKE BUTTON TEMPLATE -->
            <button class="action like-button" mix-post="{{ url_for('toggle_like_tweet') }}"
                mix-target="#post_{{ tweet.post_pk }} .like-button-container" mix-params="post_pk={{ tweet.post_pk }}">

                {% if tweet.liked_by_user %}
                <i class="fa-solid fa-heart text-red-500"></i>
                {% else %}
                <i class="fa-regular fa-heart"></i>
                {% endif %}
                <span class="post-likes">{{ tweet.post_total_likes }}</span>
            </button>

            <span class="action space-x-1 hover:text-purple-500"><i class="fa-solid fa-chart-simple"></i> 230</span>
            <span class="action space-x-1 hover:text-gray-700"><i class="fa-solid fa-share"></i></span>

            {% if tweet.post_user_fk == user.user_pk %}
            <button class="edit-post text-blue-500 hover:underline ml-2"
                onclick="editPost('{{ tweet.post_pk }}', `{{ tweet.post_message|default('')|escape }}`)">Edit</button>
            <button class="delete-post text-red-500 hover:underline ml-1"
                onclick="deletePost('{{ tweet.post_pk }}')">Delete</button>
            {% endif %}
        </div>

        <!-- COMMENTS CONTAINER -->
        <div class="comments-container mt-2 border-t border-gray-200 pt-2" id="comments_{{ tweet.post_pk }}">
            <!-- COMMENT FORM -->
            <form class="comment-form flex flex-col" data-post-pk="{{ tweet.post_pk }}">
                <input type="hidden" name="post_fk" value="{{ tweet.post_pk }}">
                <textarea name="comment" placeholder="Write a comment..."
                    class="w-full p-3 rounded-2xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-gray-900 placeholder-gray-400 transition"
                    rows="3"></textarea>
                <button type="submit"
                    class="self-end mt-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow transition-colors duration-200">
                    Comment
                </button>
            </form>

            <!-- COMMENT LIST -->
            <div class="comment-list mt-2">
                {% for comment in tweet.comments %}
                <div class="comment p-2 bg-gray-50 flex justify-between items-start border border-gray-100 shadow-sm"
                    data-comment-pk="{{ comment.comment_pk }}">
                    <div class="comment-content flex-1">
                        <strong>{{ comment.user_first_name }}:</strong>
                        <span class="comment-text">{{ comment.comment_message }}</span>
                    </div>
                    <div class="comment-actions flex space-x-2 ml-2">
                        <span class="time text-gray-400">{{ comment.created_at }}</span>

                        {% if comment.comment_user_fk == user.user_pk %}
                        <button class="edit-comment text-blue-500 hover:underline"
                            onclick="startEditComment('{{ comment.comment_pk }}', `{{ comment.comment_message|escape }}`)">Edit</button>
                        <button class="delete-comment text-red-500 hover:underline"
                            onclick="deleteComment('{{ comment.comment_pk }}')">Delete</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</article>